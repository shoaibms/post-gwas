# Reproducibility Guide: 01 – Data Preprocessing

## Objective
This guide details the computational workflow to preprocess all raw data for the maize drought G×E analysis. It transforms raw FPKM matrices, VCF genotypes, and metadata into standardized, integrated, and quality-controlled datasets ready for downstream modeling.

## Prerequisites
- **Data:** All raw data files must be present as described in `Data_note.md`.
- **Software:** Python 3.9+ and PLINK 2.0. The `plink2.exe` executable must be on the system PATH or in the project root.
- **Python Dependencies:** Install from the project root (`C:\Users\ms\Desktop\gwas\`):
  ```bash
  pip install -r requirements.txt
  ```

---

## Workflow Execution

All commands must be executed from the **project root directory** (`C:\Users\ms\Desktop\gwas\`).

### Step 1 — Audit Raw Inputs
This script assesses the integrity, dimensions, and sample/feature overlaps of the raw input files before any processing.

**Script:** `code/01_data_preprocessing/01_audit_inputs/audit_raw_inputs.py`
```bash
python code/01_data_preprocessing/01_audit_inputs/audit_raw_inputs.py
```
**Key Outputs:**
- `output/inspect/audit_report.md`
- `output/inspect/coverage_matrix.csv`

---

### Step 2 — Build Analysis Data

#### 2a — Filter Expression Data to AGPv4 Gene IDs
This script standardizes the expression matrices by filtering gene columns to match the official AGPv4 reference annotation.

**Script:** `code/01_data_preprocessing/02_build_analysis_data/01_filter_expression_to_agpv4.py`
```bash
python code/01_data_preprocessing/02_build_analysis_data/01_filter_expression_to_agpv4.py
```
**Key Outputs:**
- `output/data_filtered/WW_209-Uniq_FPKM.agpv4.txt.gz`
- `output/data_filtered/WS1_208-uniq_FPKM.agpv4.txt.gz`
- `output/data_filtered/WS2_210-uniq_FPKM.agpv4.txt.gz`

#### 2b — Prepare All Model Inputs
This is the main pipeline script. It integrates the filtered expression data with genotypes (VCF) and phenotypes, and automates the entire PLINK2 workflow for genotype processing.

**Script:** `code/01_data_preprocessing/02_build_analysis_data/02_prepare_model_inputs.py`
```bash
python code/01_data_preprocessing/02_build_analysis_data/02_prepare_model_inputs.py ^
  --cohort-csv output/cohort/core_all3_env.csv ^
  --ww output/data_filtered/WW_209-Uniq_FPKM.agpv4.txt.gz ^
  --ws1 output/data_filtered/WS1_208-uniq_FPKM.agpv4.txt.gz ^
  --ws2 output/data_filtered/WS2_210-uniq_FPKM.agpv4.txt.gz ^
  --gff3 data/maize/Zea_mesays.B73_RefGen_v4.gff3.gz
```

---

### Step 3 — Quality Control Gates

#### 3a — Check Cis-SNP Coverage
This script validates that a sufficient proportion of genes have SNP coverage within their cis-regulatory window, a critical gate for eQTL analysis.

**Script:** `code/01_data_preprocessing/03_quality_control_outputs/03_check_cis_coverage.py`
```bash
python code/01_data_preprocessing/03_quality_control_outputs/03_check_cis_coverage.py ^
  --pvar output/geno/cohort_pruned.pvar ^
  --gene_list output/data/gene_map.csv
```
**Key Output:**
- `output/reports/preflight_report.md`

#### 3b — Verify AGPv4 ID Compliance
This script provides a final confirmation that all gene identifiers in the processed expression files conform strictly to the AGPv4 format.

**Script:** `code/01_data_preprocessing/03_quality_control_outputs/04_verify_agpv4_ids.py`
```bash
python code/01_data_preprocessing/03_quality_control_outputs/04_verify_agpv4_ids.py
```
**Key Output:**
- A validation report printed to the console.

---

## Final Outputs Generated
The following files are generated by this workflow and serve as inputs for all downstream analyses.

-   `output/data/T_long.parquet`: Long-format expression data (FPKM).
-   `output/data/P.csv`: Phenotype data (survival rate) for the cohort.
-   `output/data/gene_map.csv`: Gene IDs and their genomic coordinates.
-   `output/geno/cohort_pruned.pgen`: Final LD-pruned genotype matrix (PLINK 2 format).
-   `output/geno/cohort_pruned.pvar`: Variant (SNP) metadata.
-   `output/geno/cohort_pruned.psam`: Sample metadata for the genotype matrix.
-   `output/geno/pcs.eigenvec`: Population structure principal components.
-   `output/geno/G_traw.traw`: Transposed genotype matrix (SNPs x samples).